from scriptingFunctions import funcs
from flask import Flask, render_template, redirect, request, session, url_for, sessions, flash
#I had written a library called "dbFunctions" which contains all the functions to be used on the database
from dbFunctions import generalDbFunctions, usersTableFunctions, foldersTableFunctions, articlesTableFunctions
import sqlite3

app = Flask(__name__) #Instantiates Flask as "app"
app.secret_key = "EwanLorimer"


@app.route('/') #Loads main page
def homePage():
    return render_template('menuPage.html')


@app.route('/login', methods=["POST", "GET"])#Two methods: POST and GET, POST for secure data, GET for loading pages
def loginPage():
    
    if request.method == "POST":    #If request method is POST, user has entered details.
        #Take the data from the request form and store it as "username" and "password"
        username = request.form["username"]
        password = request.form["password"]
        if funcs.checkIfNothing(username, password) == False: #Checks that the user has entered data into both forms

            #Query database for user details
            usernameCheck = usersTableFunctions.returnUsername(username)
            passwordCheck = usersTableFunctions.returnPassword(username)
            

            if username == usernameCheck and password == passwordCheck:#If form data equal to data in database, take user to mainPage and create session
                session["sessionUsername"] = username
                
                return redirect(url_for("folderPage"))
            
            else:#If details do not match tell user details are incorrect, redirect user back to loginPage
                
                return redirect(url_for("loginPage"))

        else:#If the user has not entered data into the form, it will reload the login page and not log the user in.
            return render_template("loginPage.html")
            
    return render_template("loginPage.html")




    


@app.route('/signup', methods=["POST", "GET"])
def signUpPage():
    if request.method == "POST":#If request method is post it will mean user has submitted data
        #Take submitted data from form
        username = request.form["username"]
        password = request.form["password"]
        passwordConfirm = request.form["confirmPassword"]
        
        check = funcs.checkSignUpParameters(username, password, passwordConfirm)#Check sign up paramets
        if check == True:#If details meet all parameters, check if unique
            unique = usersTableFunctions.usernameAvailable(username)
            if unique == True:#If unique, create an account and take user to main page
                usersTableFunctions.createUser(username, password)
                session["sessionUsername"] = username
                
                return redirect(url_for("folderPage"))
            
        #If the details do not meet parameters or aren't unique
        #User is redirected back to signUpPage
            else:
                return redirect(url_for("signUpPage"))

        else:
            return redirect(url_for("signUpPage"))
    else:
        return render_template('signUpPage.html')


#This is where the main note-taking app will be
@app.route('/folders', methods=["POST", "GET"])
def folderPage():
    #If the username has been found in the session, this makes sure the user has actually logged in
    if "sessionUsername" in session:
        sessionUsername = session["sessionUsername"] #username in session is stored as sessionUsername
        returnedFolders = foldersTableFunctions.returnFolders(sessionUsername)#Query the database for all of the users folders
        folderList = []#List created to store the names of folders in.

        for n in range (len(returnedFolders)):#Iterate through returned folders and store it in new list, folderList then passed to webpage as content
            folder = funcs.itemFromList(returnedFolders,n)
            folderList.append(folder)
        
        
        #Create folder in database after user submits form
        if request.method == "POST":
                folderName = request.form["folderName"]
                if len(folderName) > 0:
                    
                    foldersTableFunctions.createFolder(folderName,sessionUsername)

                    return redirect(url_for("folderPage"))
                else:
                    folderSelected = request.form["folderSelected"]
                    session["sessionFolderSelected"] = folderSelected
                    return redirect(url_for("articlesPage"))
                
                    
    else:
        return redirect(url_for('homePage'))
    return render_template('folderPage.html',content=folderList)


@app.route('/articles', methods=['GET', 'POST'])
def articlesPage():
    if "sessionFolderSelected" in session:
        folder = session["sessionFolderSelected"]
        sessionUsername = session["sessionUsername"]
        folderID = foldersTableFunctions.returnFolderID(folder, sessionUsername)
        
        returnedArticles = articlesTableFunctions.returnArticleTitles(folderID)
        articleList = []
        
        for n in range (len(returnedArticles)):
            article = funcs.itemFromList(returnedArticles, n)
            articleList.append(article)

    return render_template('articlesPage.html',content=articleList)

#Runs the program
if __name__ == "__main__":
    
    app.run()